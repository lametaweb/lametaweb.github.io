= Desarrollo de una aplicación desde cero. Diseño e implementación de la capa de persistencia.
La metaweb
:hp-tags: JPA, Hibernate, persistencia, diagrama de clases
:published_at: 2015-06-08


Continuamos con la implementación de la aplicación. Construiremos la aplicación desde la capa de persistencia hacia arriba hasta la capa de presentación, que es el modo habitual para los desarrollos Java EE por capas.

La capa de persistencia tiene como cometido establecer un mapeo con la base de datos para las entidades persistentes del modelo de dominio de manera que podamos manipular la información a través de una jerarquía de objetos Java y nos abstraiga totalmente de los detalles de la base de datos. El modelo de dominio es un documento de la fase de análisis del proyecto que consiste en una serie de diagramas de clase donde se determinan las entidades relevantes para nuestro proyecto, la información contenida en cada una y las relaciones entre ellas. 

En el plano tecnológico tenemos que definir lo siguiente:

* El proveedor de persistencia: Es el conjunto de librerías que implementan el ORM. Elegimos Hibernate, ya que es el más extendido y además viene de serie en nuestro servidor JBoss.

* El gestor de base de datos: Usamos una base de datos Derby embebida lo que nos permite simplificar de momento la capa de Datos del proyecto evitando la necesidad de instalar un servidor de base de datos, ya que el gestor de base de datos está contenido en este caso en un archivo jar, junto con el driver. Por otro lado con Derby podemos tener el esquema de la base de datos, es decir donde residen las tablas, en memoria o en el disco duro, nosotros elegimos esta última opción para tener la posibilidad de explorar los elementos que hibernate generará de forma automática. No he querido usar la base de datos H2, que trae puesta el servidor JBoss EAP, similar a la base de datos Derby, para que veamos también como desplegar recursos en el servidor desde Maven.

¿Y qué elementos tenemos que añadir a la capa de persistencia? Pues por un lado un fichero de configuración, donde definimos todo lo relevante, y que leerá Hibernate, y por otro las clases del mapeo objeto relacional, basadas en la tecnología JPA, y que eran tres: Drone, Trabajo y PuntoRuta. Y no hay más, mucho más simple y limpio que en versiones pasadas de EJB.

Vamos primero con el fichero de configuración. El fichero de configuración de la unidad de persitencia es _persistence.xml_. La especificación JPA2 (JSR-338) permite desplegar clases de persistencia fuera de un empaquetado JAR, directamente dentro del WAR de nuestra aplicación. En este caso se indica que el fichero persistence.xml debe situarse en la carpeta _WEB-INF/classes/META-INF/_ . Por lo tanto, y con arreglo a la configuración por defecto de Maven para los ficheros de recursos, en nuestro proyecto tendremos que crear el fichero en la carpeta _src\main\resources\META-INF\_. Creamos el fichero en la opción de menú _New > Other... > XML > XML File_.


.Fichero de configuración de persistencia
[cols="1h,5"]
|===
|Nombre 
|persistence.xml 

|Ruta
|jdrone/src/main/resources/META-INF/
|===

image::https://raw.githubusercontent.com/lametaweb/lametaweb.github.io/master/images/003/post003-fig040.png[]

Copiamos el siguiente contenido en el fichero persistence.xml:

[source,xml,identation=0]
----
	<?xml version="1.0" encoding="UTF-8"?>
	<persistence xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd" version="2.0">
		<persistence-unit name="datosdrones" transaction-type="JTA">
			<jta-data-source>java:jboss/datasources/DerbyDS</jta-data-source>
			<exclude-unlisted-classes>false</exclude-unlisted-classes>
			<properties>
				<property name="hibernate.dialect" value="org.hibernate.dialect.DerbyDialect" />
				<property name="hibernate.hbm2ddl.auto" value="create-drop" />
			</properties>
		</persistence-unit>
	</persistence>
----

