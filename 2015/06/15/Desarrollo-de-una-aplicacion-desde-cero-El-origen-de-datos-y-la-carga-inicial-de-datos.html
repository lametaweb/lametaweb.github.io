<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Desarrollo de una aplicación desde cero: El origen de datos y la carga inicial de datos.</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="//www.lametaweb.com/themes/ichi/favicon.ico">

    <script type="text/javascript" src="//www.lametaweb.com/themes/ichi/assets/js/vendor/fastclick.js?v=1.0.0"></script>
    <script type="text/javascript" src="//www.lametaweb.com/themes/ichi/assets/js/vendor/modernizr.js?v=1.0.0"></script>


    <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/css/normalize.css?v=1.0.0" />
    <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/css/foundation.min.css?v=1.0.0" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/css/outdatedBrowser.min.css?v=1.0.0">
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/fonts/foundation-icons/foundation-icons.css?v=1.0.0" />
    <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/css/styles.css?v=1.0.0" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300,700,400|Source+Sans+Pro:300,400,600,700,900,300italic,400italic,600italic,700italic,900italic" />

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="//www.lametaweb.com/themes/ichi/assets/css/asciidoctor.css?v=1.0.0" />

    <link rel="canonical" href="http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html" />
    
    <meta property="og:site_name" content="La metaweb" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Desarrollo de una aplicación desde cero: El origen de datos y la carga inicial de datos." />
    <meta property="og:description" content="En este post veremos en primer lugar qué es un origen de datos, su relación con la capa de persistencia y la configuración e instalación en nuestra aplicación. Y a continuación implementaremos un proceso de carga de datos inicial simple..." />
    <meta property="og:url" content="http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html" />
    <meta property="article:published_time" content="2015-06-14T22:00:00.000Z" />
    <meta property="article:modified_time" content="2015-06-15T10:17:25.665Z" />
    <meta property="article:tag" content="JPA" />
    <meta property="article:tag" content="Hibernate" />
    <meta property="article:tag" content="Persistencia" />
    <meta property="article:tag" content="DataSource" />
    <meta property="article:tag" content="EntityManager" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Desarrollo de una aplicación desde cero: El origen de datos y la carga inicial de datos." />
    <meta name="twitter:description" content="En este post veremos en primer lugar qué es un origen de datos, su relación con la capa de persistencia y la configuración e instalación en nuestra aplicación. Y a continuación implementaremos un proceso de carga de datos inicial simple..." />
    <meta name="twitter:url" content="http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "La metaweb",
    "author": {
        "@type": "Person",
        "name": "La metaweb",
        "image": "https://avatars.githubusercontent.com/u/11819148?v=3",
        "url": "undefined/author/undefined",
        "sameAs": ""
    },
    "headline": "Desarrollo de una aplicación desde cero: El origen de datos y la carga inicial de datos.",
    "url": "http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html",
    "datePublished": "2015-06-14T22:00:00.000Z",
    "dateModified": "2015-06-15T10:17:25.665Z",
    "keywords": "JPA,  Hibernate,  Persistencia,  DataSource,  EntityManager",
    "description": "En este post veremos en primer lugar qué es un origen de datos, su relación con la capa de persistencia y la configuración e instalación en nuestra aplicación. Y a continuación implementaremos un proceso de carga de datos inicial simple..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="La metaweb" href="http://www.lametaweb.com/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template tag-JPA tag-Hibernate tag-Persistencia tag-DataSource tag-EntityManager">

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdate" href="http://outdatedbrowser.com/">Update my browser now</a></p>
</div>

<nav class="top-bar hide-for-large-up" data-topbar style="background: none">
  <ul class="title-area">
    <li class="name">

    </li>
    <li class="home"><a class="fi-home" href="http://www.lametaweb.com"></a></li>
    <li class="toggle-topbar"><a href="#" id="trigger-overlay" class="fi-list"></a></li>
  </ul>

<div class="overlay overlay-scale">
    <button type="button" class="overlay-close">Close</button>
    <nav>
        <ul>
            <li><a href="http://www.lametaweb.com">Home</a></li>
        </ul>
    </nav>
</div>

</nav>

<div class="row">

<div class="small-16 medium-16 large-4 columns right head-area bgimage" style="background-image: url(https://raw.githubusercontent.com/lametaweb/lametaweb.github.io/master/images/red20vertical.jpg)">

<header class="site-head">
    <div class="vertical">
        <div class="site-head-content inner">
            <ul class="side-nav blog-menu show-for-large-up">
                <li><a class="fi-home" href="http://www.lametaweb.com"></a></li>
                <li><a class="fi-torso" href="http://www.lametaweb.com/about"></a></li>
                <li><a class="fi-mail" href="http://www.lametaweb.com/contact"></a></li>
            </ul>
            <a class="blog-logo" href="http://www.lametaweb.com"><img alt="La metaweb" src="https://raw.githubusercontent.com/lametaweb/lametaweb.github.io/master/images/logo-blanco.png" alt="Blog Logo" /></a>
            <h1 class="blog-title">La metaweb</h1>
            <hr>
            <p class="blog-description">Blog sobre desarrollo web en el estándar Java EE, con algún off topic para desconectar ;-)</p>
            <div class="blog-network">
<!--                 <a href="#" class="fi-social-pinterest"></a>
                <a href="#" class="fi-social-linkedin"></a>
                <a href="#" class="fi-social-behance"></a>
                <a href="#" class="fi-social-deviant-art"></a>
                <a href="#" class="fi-social-dribbble"></a>
                <a href="#" class="fi-social-flickr"></a>
                <a href="#" class="fi-social-github"></a>
                <a href="#" class="fi-social-skype"></a>
                <a href="#" class="fi-social-snapchat"></a>
                <a href="#" class="fi-social-steam"></a>
                <a href="#" class="fi-social-xbox"></a>
                <a href="#" class="fi-social-reddit"></a> -->
            </div>
        </div>
    </div>
</header>

</div>


<div class="small-16 medium-16 large-12 columns main-column left">
    

<main class="content" role="main">

    <article class="post tag-JPA tag-Hibernate tag-Persistencia tag-DataSource tag-EntityManager">


            <h1 class="post-title">Desarrollo de una aplicación desde cero: El origen de datos y la carga inicial de datos.</h1>

            <span class="post-meta label"><time datetime="2015-06-15">15 Jun 2015</time></span>

            <section class="post-content">
                <div class="paragraph">
<p>En este post veremos en primer lugar qué es un origen de datos, su relación con la capa de persistencia y la configuración e instalación en nuestra aplicación. Y a continuación implementaremos un proceso de carga de datos inicial simple que si bien no representa un ejemplo de carga de datos en un proyecto real sí servirá para nuestro propósito, disponer de datos que gestionar, y además nos mostrará un primer ejemplo de persistencia en JPA y además un tipo interesante de bean EJB introducido en la versión 6 de Java EE.</p>
</div>
<div class="paragraph">
<p>Un origen de datos o datasource es un recurso de servidor que permite a una aplicación comunicarse con un gestor de base de datos, a través del proveedor de persistencia, para realizar operaciones de consulta y modificación sobre un esquema de datos. El origen de datos necesita sin embargo un elemento adicional para realizar su función, el driver, que consiste en un conjunto de librerías que traducen los comandos del proveedor de datos en comandos específicos de la base de datos utilizada: Oracle, PostgreSQL, MySQL, etc.</p>
</div>
<div class="paragraph">
<p>La instalación del datasource puede hacerse de distintas maneras. En nuestro caso la incluiremos dentro del ciclo de construcción del proyecto, en el archivo pom.xml, para que de este modo tengamos toda la información necesaria en un mismo sitio. Tambíen veremos sin embargo una manera de instalar el datasource en el servidor de forma manual, no automatizada, ya que es como comúnmente se hace en proyecto reales.</p>
</div>
<div class="paragraph">
<p>Bien, empezamos. Abrimos Eclipse y a continuación el fichero pom.xml del proyecto. Añadimos la dependencia correspondiente al driver JDBC de Derby del que tirará el datasource con un copia pega del siguiente fragmento de XML dentro del elemento &lt;dependencies&gt;:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.derby&lt;/groupId&gt;
    &lt;artifactId&gt;derby&lt;/artifactId&gt;
    &lt;version&gt;10.11.1.1&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como vemos el scope de la dependencia es <em>runtime</em>, ya que no es necesario en tiempo de compilación pero si cuando la aplicación se esté ejecutando en el servidor. Es decir, el proveedor de persistencia lo invocará para llevar a cabo las operaciones contra la base de datos, pero en ningún lugar de nuestro código usaremos ninguna de las clases de las librerías del driver directamente.</p>
</div>
<div class="paragraph">
<p>Y ahora viene lo interesante, hacemos uso del plugin de Maven para el servidor JBoss para llevar a cabo de forma automatizada las tareas de despliegue que necesitamos, que por orden son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desinstalar una instalación pevia de la aplicación si existía.</p>
</li>
<li>
<p>Instalar el artefacto correspondiente al driver a nivel de servidor como un despliegue estándar.</p>
</li>
<li>
<p>Instalar el datasource como recurso de servidor si éste no está ya instalado.</p>
</li>
<li>
<p>Y finalmente desplegar nuestra aplicación.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Y todo esto haciendo un simple click de ratón. Es un buen ejemplo de como Maven puede ayudarnos a centrarnos en implementar el diseño de nuestra aplicación evitándonos tener que dedicar tiempo a tareas que no son puramente de desarrollo.</p>
</div>
<div class="paragraph">
<p>Copiamos y pegamos en el fichero pom.xml lo siguiente bajo el elemento <em>project/build/plugins</em>. Recordad que podemos formatear el XML con la hotkey Ctrl + Shift + F para que quede más ordenado después de pegar el contenido.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.jboss.as.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;jboss-as-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;7.6.Final&lt;/version&gt;

    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;undeploy&lt;/id&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;undeploy&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;deploy-driver&lt;/id&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;groupId&gt;org.apache.derby&lt;/groupId&gt;
                &lt;artifactId&gt;derby&lt;/artifactId&gt;
                &lt;name&gt;derby.jar&lt;/name&gt;
            &lt;/configuration&gt;
            &lt;goals&gt;
                &lt;goal&gt;deploy-artifact&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;add-datasource&lt;/id&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;configuration&gt;
                &lt;address&gt;subsystem=datasources,data-source=DerbyDS&lt;/address&gt;
                &lt;resource&gt;
                    &lt;enableResource&gt;true&lt;/enableResource&gt;
                    &lt;properties&gt;
                        &lt;connection-url&gt;jdbc:derby:c:\BD\drones;create=true&lt;/connection-url&gt;
                        &lt;driver-class&gt;org.apache.derby.jdbc.EmbeddedDriver&lt;/driver-class&gt;
                        &lt;jndi-name&gt;java:jboss/datasources/DerbyDS&lt;/jndi-name&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                        &lt;enable&gt;true&lt;/enable&gt;
                        &lt;pool-name&gt;DerbyDS&lt;/pool-name&gt;
                        &lt;user-name&gt;root&lt;/user-name&gt;
                        &lt;password&gt;root&lt;/password&gt;
                        &lt;driver-name&gt;derby.jar&lt;/driver-name&gt;
                        &lt;use-ccm&gt;false&lt;/use-ccm&gt;
                        &lt;force&gt;true&lt;/force&gt;
                    &lt;/properties&gt;
                &lt;/resource&gt;
            &lt;/configuration&gt;
            &lt;goals&gt;
                &lt;goal&gt;add-resource&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
        &lt;execution&gt;
            &lt;id&gt;deploy&lt;/id&gt;
            &lt;phase&gt;install&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;deploy&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;

    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>En general bajo el elemento &lt;plugins&gt; podemos declarar plugins de Maven para diferentes propósitos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ejecutarlo en nuestro proyecto de forma manual, bien a través de la linea de comnandos o bien desde Eclipse en la opción <em>Run &gt; Run Configurations&#8230;&#8203;</em>.</p>
</li>
<li>
<p>Cambiar la configuración de un plugin del ciclo de vida por defecto.</p>
</li>
<li>
<p>Incluir la ejecución de uno o más goals como parte de alguna fase del ciclo de vida por defecto. Para esto debemos declarar el plugin, y añadir un elemento &lt;execution&gt; por cada goal/fase que queramos añadir.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El fragmento añadido es un ejemplo del tercer caso y ejecuta cuatro goals del plugin del servidor JBoss en la fase install del ciclo de vida por defecto. Los goals se ejecutan en el orden en que aparecen en el fichero pom.xml. Para consultar la documentación y tener una idea de las posibilidades del plugin del servidor JBoss podéis ir a este <a href="https://docs.jboss.org/jbossas/7/plugins/maven/latest/index.html">enlace</a>.</p>
</div>
<div class="paragraph">
<p>Aprovechamos que estamos tocando el pom.xml para añadir un elemento &lt;plugin&gt; adicional que evitará de momento la ejecución de las pruebas unitarias, en la fase Test,  hasta que tengamos alguna prueba implementada. Esto sería un ejemplo del segundo tipo visto en la lista anterior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.18.1&lt;/version&gt;
    &lt;configuration&gt;
        &lt;skipTests&gt;true&lt;/skipTests&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hasta aquí el despliegue automatizado con Maven. Veamos un despliegue equivalente pero realizado de forma manual. La manera en que se añaden nuevas librerías a nivel de servidor es diferente desde la versión 6 de JBoss, y se basa en módulos. Podéis leer <a href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6/html/Development_Guide/chap-Class_Loading_and_Modules.html">esta documentación</a> para entender mejor el nuevo mecanismo de carga de clases y recursos en JBoss 6+.</p>
</div>
<div class="paragraph">
<p>De hecho en el despligue anterior del driver desde Maven el servidor ha generado un modulo. En este caso un módulo dinámico con el nombre <em>deployment.derby.jar</em> asociado al despliegue de la librería derby.jar. En el despliegue manual lo que creamos es un módulo estático, que se carga en el arranque del servidor y no asociado al despliegue de una aplicación como en el caso del dinámico.</p>
</div>
<div class="paragraph">
<p>En resumen hay que hacer dos cosas. La primera es añadir un nuevo módulo estático para incluir el driver JDBC de Derby en el servidor, y en segundo lugar tenemos que añadir la configuración del datasource en el fichero de configuración del servidor. Lógicamente tenéis que optar por una de las dos estrategías, la automatizada con Maven ya vista o ésta que vamos a ver ahora. Para librerías de uso general compartidas por varias aplicaciones es más conveniente delegar en el equipo de administradores de sistemas la creación de los módulos estáticos que requiramos.</p>
</div>
<div class="paragraph">
<p>Los pasos a seguir para la instalación manual son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creación del módulo para la carga del driver derby.jar:</p>
<div class="ulist">
<ul>
<li>
<p>Descargar el fichero .zip de derby en <a href="http://db.apache.org/derby/releases/release-10.10.1.1.html">esta dirección</a>.</p>
</li>
<li>
<p>Extraer el fichero \lib\derby.jar y copiarlo en un lugar temporal, por ejemplo en el escritorio.</p>
</li>
<li>
<p>Ir a la carpeta <em>C:\TALLER\Servidor\EAP-6.3.0\jboss-eap-6.3\modules\system\layers\base\org\apache\</em></p>
</li>
<li>
<p>Crear dentro de la anterior la carpeta <em>derby\main\</em></p>
</li>
<li>
<p>Situarnos dentro de la nueva carpeta.</p>
</li>
<li>
<p>Copiar el fichero derby.jar en la carpeta.</p>
</li>
<li>
<p>Con un editor de textos, por ejemplo Notepad++, crear un fichero con el nombre <em>module.xml</em> en la misma carpeta y con el siguiente contenido:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;module xmlns="urn:jboss:module:1.0" name="org.apache.derby"&gt;
    &lt;resources&gt;
        &lt;resource-root path="derby.jar"/&gt;
    &lt;/resources&gt;
    &lt;dependencies&gt;
        &lt;module name="javax.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir el datasource:</p>
<div class="ulist">
<ul>
<li>
<p>Ir a la carpeta <em>C:\TALLER\Servidor\EAP-6.3.0\jboss-eap-6.3\standalone\configuration\</em></p>
</li>
<li>
<p>Abrir el fichero <em>standalone.xml</em> con un editor de textos.</p>
</li>
<li>
<p>Añadir el siguiente fragmento XML dentro del elemento <em>&lt;subsystem xmlns="urn:jboss:domain:datasources:1.2"&gt;&lt;datasources&gt;</em>:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;datasource jndi-name="java:jboss/datasources/DerbyDS" pool-name="DerbyDS" enabled="true" use-ccm="false"&gt;
    &lt;connection-url&gt;jdbc:derby:c:\BD\drones;create=true&lt;/connection-url&gt;
    &lt;driver&gt;org.apache.derby&lt;/driver&gt;
    &lt;security&gt;
        &lt;user-name&gt;root&lt;/user-name&gt;
        &lt;password&gt;root&lt;/password&gt;
    &lt;/security&gt;
    &lt;validation&gt;
        &lt;validate-on-match&gt;false&lt;/validate-on-match&gt;
        &lt;background-validation&gt;false&lt;/background-validation&gt;
    &lt;/validation&gt;
    &lt;statement&gt;
        &lt;share-prepared-statements&gt;false&lt;/share-prepared-statements&gt;
    &lt;/statement&gt;
&lt;/datasource&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadir también el siguiente fragmento XML dentro del elemento <em>&lt;subsystem xmlns="urn:jboss:domain:datasources:1.2"&gt;&lt;datasources&gt;&lt;drivers&gt;</em>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;driver name="org.apache.derby" module="org.apache.derby"&gt;
    &lt;xa-datasource-class&gt;org.apache.derby.jdbc.EmbeddedXADataSource&lt;/xa-datasource-class&gt;
&lt;/driver&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Y con esto bastaría para instalar de forma permanente un origen de datos específico para nuestra aplicación y por otro lado un driver de acceso a bases de datos Derby que puede ser usado por cualquier aplicación que despleguemos en el servidor.</p>
</div>
<div class="paragraph">
<p>Veamos lo más relevante del contenido XML:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fichero module.xml: Es el fichero de configuración de un módulo en JBoss. Un módulo representa una serie de recursos o bien una serie de dependencias o ambas cosas como en nuestro caso. El nombre del módulo es <em>org.apache.derby</em> y el fichero module.xml debe estar en la carpeta <em>RUTA_BASE_MODULOS\org\apache\derby\main\</em>. Dentro de esta carpeta también está el recurso, derby.jar. Nuestro módulo dependerá del módulo "javax.api" que representa a su vez múltiples dependencias con paquetes del grupo javax que el driver necesitará para su ejecución.</p>
</li>
<li>
<p>Elemento &lt;datasource&gt;: Define un origen de datos identificado por un nombre JNDI del tipo <em>java:jboss/datasources/NOMBRE_DS</em>. Como nombre del pool podemos usar el que queramos. El elemento &lt;connection-url&gt; nos dice que ruta de la base de datos estará en el disco duro en la ruta <em>C:\BD\drones\</em> y que se creará una base de datos vacía si no existía ya anteriormente. En el elemento &lt;driver&gt; pondremos el nombre del módulo que hemos creado.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vamos con la segunda parte del post, implementar una carga inicial de datos. He decidido hacerlo desde la propia aplicación porque así podemos ver un primer ejemplo de persistencia de datos con JPA y además un tipo de bean EJB que permite realizar acciones en el inicio de una aplicación web.</p>
</div>
<div class="paragraph">
<p>Necesitamos una manera de ejecutar el código Java de carga en el inicio de la aplicación y para esto tenemos que ínstanciar un bean en ese momento y colocar el código en un método anotado con <em>@PostConstruct</em> para que se ejecute sin necesidad de una llamada explícita al mismo. La carga del bean podemos hacerla de tres maneras diferentes usando en cada caso una tecnología diferente: EJB, JSF o bien CDI. Vemos cada caso y al final decidimos cual es el más conveniente para nosotros.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EJB: A través de un bean de sesión singleton. Se trata de un bean con estado que se carga una sola vez la primera vez que se hace referencia al mismo desde la aplicación. La anotación <em>@Startup</em> se usa para obligar a una carga en el arranque de la aplicación. Aquí el estado no nos interesa en cualquier caso. La definición de la clase para el bean sería:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Singleton
@Startup
@ConcurrencyManagement(BEAN)
public class PropertyRegistry {
    @PostConstruct
    public void applicationStartup() {
        // carga inicial
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>JSF: Esta alternativa, aunque la cito, de entrada no la usaremos ya que pasa por usar un atributo en la anotación <em>@ManageadBean</em>, que estará deprecada probablemente en la siguiente versión de JSF, la 2.3. En vez de esta anotación tenemos siempre que usar una de entre las que expresan el ámbito del bean, ya sea una anotación CDI o una compatible con CDI, como <em>@ViewScoped</em> o <em>@FlowScoped</em>. En este caso la clase del bean de controlador tendría este aspecto:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ManagedBean(eager=true)
@ApplicationScoped
public class GlobalBean {
    @PostConstruct
    public void applicationStartup() {
        // carga inicial
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>CDI: De momento CDI no proporciona una solución concreta para la carga de un bean asociado a un evento de inicio de aplicación, ni siquiera en su última versión 1.1, la incluida con Java EE 7. Es previsible que en el futuro se extienda la anotación <em>@Startup</em> de EJB a cualquier bean de CDI con el nuevo stack Java EE 8. Actualmente, si lo necesitaramos, podríamos implementar nosotros mismos una extensión de CDI para obtener cargas iniciales usando la técnica que se explica en <a href="http://ovaraksin.blogspot.com.es/2013/02/eager-cdi-beans.html">este enlace</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bien, como vemos, técnica y conceptualmente, en nuestro caso, lo más acertado es usar un bean singleton. Vamos a ello. Abrimos a Eclipse, hacemos botón derecho sobre la carpeta negocio y elegimos la opción <em>New &gt; Other&#8230;&#8203; &gt; EJB &gt; Session Bean</em>. En la pantalla de configuración del bean introducimos los valores que se indican en la figura y pulsamos el botón <em>Finish</em>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/lametaweb/lametaweb.github.io/master/images/003/post003-fig062.png" alt="post003 fig062.png">
</div>
</div>
<div class="paragraph">
<p>Para este bean singleton usamos además, como se ve en la figura, otra nueva característica de Java EE 6, No-interface View, a través de la anotación <em>@LocalBean</em>, que permite evitar la creación de una interfaz local o remota para nuestro bean. Como nuestra aplicación se va a ejecutar en una sola máquina virtual simplificamos nuestro diseño prescindiendo de las interfaces.</p>
</div>
<div class="paragraph">
<p>Seguimos con la implementación de nuestro bean CargaInicialDatos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Añadimos la anotación <em>@Startup</em> a la clase.</p>
</li>
<li>
<p>Añadimos el atributo de clase <em>em</em> para inyectar el entity manager:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@PersistenceContext(unitName = "datosdrones")
private EntityManager em;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Y finalmente añadimos el método para la carga inicial de datos anotado con <em>@PostConstruct</em>, quedándo el código de la clase así:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.lametaweb.jdrone.negocio;

import java.util.Date;
import java.util.GregorianCalendar;
import javax.annotation.PostConstruct;
import javax.ejb.LocalBean;
import javax.ejb.Singleton;
import javax.ejb.Startup;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import com.lametaweb.jdrone.persistencia.Drone;
import com.lametaweb.jdrone.persistencia.PuntoRuta;
import com.lametaweb.jdrone.persistencia.Trabajo;

/**
 * Session Bean implementation class CargaInicialDatos
 */
@Singleton
@Startup
@LocalBean
public class CargaInicialDatos {

    /**
     * Default constructor.
     */

    @PersistenceContext(unitName = "datosdrones")
    private EntityManager em;

    public CargaInicialDatos() {
        // TODO Auto-generated constructor stub
    }

    @PostConstruct
    public void cargaDeDatos(){
	// Puntos de Ruta
	PuntoRuta puntoRuta01 = new PuntoRuta();
	PuntoRuta puntoRuta02 = new PuntoRuta();
	PuntoRuta puntoRuta03 = new PuntoRuta();
	PuntoRuta puntoRuta04 = new PuntoRuta();
	PuntoRuta puntoRuta05 = new PuntoRuta();

	// Datos Puntos de Ruta
	puntoRuta01.setLatitud(37.367873f);
	puntoRuta01.setLongitud(-6.003724f);
	puntoRuta01.setAltitud(100.0f);
	puntoRuta02.setLatitud(37.374797f);
	puntoRuta02.setLongitud(-5.996119f);
	puntoRuta02.setAltitud(200.0f);
	puntoRuta03.setLatitud(37.372000f);
	puntoRuta03.setLongitud(-5.992500f);
	puntoRuta03.setAltitud(300.0f);
	puntoRuta04.setLatitud(37.367873f);
	puntoRuta04.setLongitud(-6.003724f);
	puntoRuta04.setAltitud(100.0f);
	puntoRuta05.setLatitud(37.367873f);
	puntoRuta05.setLongitud(-6.003724f);
	puntoRuta05.setAltitud(0.0f);

	GregorianCalendar gc = new GregorianCalendar();
	// hora inicio adelantando una hora
	gc.add(GregorianCalendar.HOUR, -1);
	Date fechaHoraInicio = gc.getTime();
	// hora finalización atrasando una hora
	gc.add(GregorianCalendar.HOUR, 2);
	Date fechaHoraFinalizacion = gc.getTime();

	Trabajo trabajo = new Trabajo();
	trabajo.setNumeroDeRegistro("trabajo");
	trabajo.setVelocidad(10f);
	trabajo.setDescripcion("Reconocimiento de zona a baja cota.");
	trabajo.setFechaHoraInicio(fechaHoraInicio);
	trabajo.setFechaHoraFinalizacion(fechaHoraFinalizacion);

	trabajo.getPuntosDeRuta().add(puntoRuta01);
	trabajo.getPuntosDeRuta().add(puntoRuta02);
	trabajo.getPuntosDeRuta().add(puntoRuta03);
	trabajo.getPuntosDeRuta().add(puntoRuta04);
	trabajo.getPuntosDeRuta().add(puntoRuta05);

	Drone drone = new Drone();
	drone.setNumeroDeSerie("FJHCAM01001");
	drone.setModelo("Observer II");
	drone.setPesoMaximoDespegue(1500);
	drone.setAutonomia(25);
	drone.setNumMotores(6);
	em.persist(drone);
	em.persist(trabajo);

	trabajo.setDroneAsignado(drone);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Antes de analizar el código del método será bueno ver una introducción exprés a la persistencia en JPA.</p>
</div>
<div class="paragraph">
<p>En JPA el objeto central es el EntityManager. A través de los métodos de este objeto llevaremos a cabo las operaciones de persistencia que necesitemos. Los datos asociados a estas operaciones de persistencia serán jerarquías de las entidades persistentes, Drone, Trabajo y PuntoRuta, y deberemos gestionarlos dentro de una zona de memoria llamada contexto de persistencia. El contexto de persistencia no debe confundirse con la unidad de persistencia, cuya configuración se encuentra en el fichero persistence.xml, y que define un conjunto de entidades persistentes y su almacen de datos.</p>
</div>
<div class="paragraph">
<p>Las operaciones de persistencia que más usaremos serán: persist, merge, remove y find, que implementan, a grandes rasgos, las operaciones de alta, modificación, baja y consulta, respectivamenete, conocidas por sus iniciales en inglés CRUD (Create, Read o Retrieve, Update y Delete). Por otra parte una entidad persistente, como por ejemplo Drone puede existir sólo en cuatro estados: new, managed, detached y removed.</p>
</div>
<div class="paragraph">
<p>El objeto EntityManager es usado desde la capa de negocio, donde se sitúa el bean para la carga inicial de datos CargaInicialDatos y el bean que veremos en el próximo post para la implementación del caso de uso de nuestra aplicación. Como ya sabemos nuestra capa de negocio usa la tecnología EJB. En un bean EJB puedo inyectar directamente un contexto de persistencia gestionado por el contenedor y entonces tendré disponible la tecnología JTA que proporciona una gestion de las transacciones automática de modo que dentro de una transacción accederé por inyección siempre al mismo entitymanager, y éste será destruido cuando la transacción finalice. Así que usando EJB y JTA me puedo centrar totalmente en las operaciones de negocio abstrayéndome de los detalles técnicos.</p>
</div>
<div class="paragraph">
<p>Vamos con nuestro código de carga inicial de datos. En resumen, da de alta en la base de datos un Trabajo con una ruta determinada y un Drone que es el que se configura para realizar ese trabajo. Podeis ver que sólo necesito manejar objetos de la capa de datos, quedando los detalles de la base de datos ocultos por la tecnología JPA. Veamos  un poco más en detalle el código desde el principio. Es conveniente que tengáis delante el diagrama de diseño que vimos en el post anterior para entender más facilmente el código:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En una carga de datos nuestro objetivo es dar de alta una serie de datos en la base de datos. En JPA para dar de alta información tengo que crear la jerarquía de objetos que queremos dar de alta, dar valor a los atributos y establecer las relaciones entre ellos. Los nuevos objetos tienen un estado new en el cual aún no están dentro del contexto de persistencia.</p>
</li>
<li>
<p>Creamos y seteamos los beans PuntoRuta de la ruta para el trabajo. Se define una ruta triangular cerrada siendo el punto inicial y final por tanto el mismo. Podéis verla en la siguiente figura:</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/lametaweb/lametaweb.github.io/master/images/003/post003-fig063.png" alt="post003 fig063.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A continuación se crea el objeto Trabajo y se inicializan sus atributos. Para el intervalo de comienzo y finalización del trabajo se calcula una hora hacia atrás y una hacia delante respecto del momento en que iniciamos la aplicación. Esto lo hago simplemente para que en la aplicación se muestre este drone introduciendo una fecha y hora que correspondan aproximadamente a la fecha y hora de ese momento.</p>
</li>
<li>
<p>Los objetos PuntoRuta son añadidos a la colección que implementa la relación uno a mucho entre Trabajo y PuntoRuta.</p>
</li>
<li>
<p>Creamos el objeto Drone y seteamos los atributos. En este punto el contexto de persistencia está aún vacío.</p>
</li>
<li>
<p>Queremos guardar dos objetos independientes, Trabajo y Drone, entre los que existe una asocicación bidireccional y uno de ellos, Trabajo, se relaciona además con N objetos dependientes PuntoRuta. Entendemos independientes en el sentido de que no hay una relación todo/parte y por tanto su persistencia se debe gestionar de forma independiente. Tendremos por tanto que persistir por separado los dos objetos, además de la relación. Para los beans PuntoRuta no ocurre igual como veremos en un momento.</p>
</li>
<li>
<p>En una relación bidireccional existe lo que se entiende por lado dueño de la relación, que es aquel en el que se expresa la relación. En este caso el lado dueño de la relación entre Drone y Trabajo está en la entidad Trabajo ya que a través de la anotación @JoinColumn se expresa la relación. Como lo que queremos es persistir la relación bastará con dar valor al lado dueño de la relación.</p>
</li>
<li>
<p>La persistencia la hacemos de la siguiente manera: Persistimos primero por ejemplo el objeto Drone, usando el método <em>persist</em> del entity manager. Esto provoca un cambio de estado en el objeto Drone desde new a managed. El objeto está ahora dentro del contexto de persistencia. No está aún en la base de datos. Y a continuación persistimos el objeto Trabajo. Y finalmente damos valor al lado dueño de la relación. No es la única manera manera pero he querido hacerlo en ese orden para aclarar los conceptos. Al persistir una entidad esta pasa a managed en el contexto como ya hemos visto, pues bien todos las asignaciones sobre los atributos de una entidad managed serán persistidas, cuando la transacción se complete. La transacción se completa cuando el método termina de ejecutarse. En este punto el proveedor de persistencia sincroniza el contexto de  persistencia con la base de datos. Verá que en el contexto existen varias entidades managed que no existen en la base de datos y procederá a darlas de alta.</p>
</li>
<li>
<p>En cuanto a las entidades PuntoRuta, si miramos el diagrama de diseño observamos que existe una relación de composición con Trabajo, y por tanto cuando persistamos un trabajo deberemos persistir también los puntos de ruta asociados. Esto se implementa con el atributo cascade de la anotación @OneToMany <code>@OneToMany (cascade = CascadeType.ALL)</code>. Por tanto tras el método persist sobre Trabajo todos los PuntoRuta pasaron del estado new al estado managed, y al finalizar la transacción de igual manera se persistieron.</p>
</li>
<li>
<p>Y entonces surge la pregunta, ¿y el método merge, no era el que debía usar para hacer un update? Bueno, sí y no. En este caso en que el objeto sobre el que hago el update es managed, porque le he aplicado un persist tras crearlo, o bien en el caso en que lo hubiera leido desde la base de datos con un find donde su estado también sería managed, la operación update se realiza automáticamente con el commit de la transacción. El método merge se usa para realizar un update sobre entidades que leo de la base de datos y mantengo en el controlador por ejemplo durante una sesión de edición de usuario a través del navegador web. Cuando el usuario pulsa el botón Guardar lo que se envía a la capa de negocio es una entidad en el estado detached, o sea con identidad persistente pero fuera del contexto de persistencia, y en este caso es el método merge el que mete de nuevo al objeto en el contexto de persistencia, y como en el primer caso, ahora sí cuando la transacción termina los cambios se hacen efectivos en la base de datos.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Como veis hemos sido capaces de implementar las operaciones de persistencia abstrayéndonos totalmente de los detalles de la base de datos. Si logramos entender bien los distintos estados de una entidad y las distintas operaciones de persistencia seremos entonces capaces de desarrollar componentes de negocio para cualquier base de datos.</p>
</div>
<div class="paragraph">
<p>Para afianzar los conceptos de persistencia vistos en este ejemplo y entender otros que en el ejemplo no aparecen podeis leer el contenido de <a href="https://en.wikibooks.org/wiki/Java_Persistence/Persisting">esta dirección</a>.</p>
</div>
<div class="paragraph">
<p>Y hasta aquí este post dedicado a la capa de datos. En el anterior vimos la parte de mapeo y aquí la configuración y una introducción a las operaciones de persistencia a través de la carga inicial de datos. En el proximo post veremos rápidamente cómo inspeccionar la base de datos Derby que Hibernate nos genera y nos meteremos ya con la capa de negocio. Nos vemos en breve!</p>
</div>
                        <aside class="tags fi-pricetag-multiple">Posted on <a href="http://www.lametaweb.com/tag/JPA">JPA</a>, <a href="http://www.lametaweb.com/tag/Hibernate"> Hibernate</a>, <a href="http://www.lametaweb.com/tag/Persistencia"> Persistencia</a>, <a href="http://www.lametaweb.com/tag/DataSource"> DataSource</a>, <a href="http://www.lametaweb.com/tag/EntityManager"> EntityManager</a></aside>
            </section>
            <hr>
            <footer class="post-footer">

                <section class="share">
                    <h4>Liked this post ? Share it.</h4>
                    <a class="fi-social-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html"
                        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    </a>
                    <a class="fi-social-twitter" href="https://twitter.com/share?text=Desarrollo%20de%20una%20aplicaci%C3%B3n%20desde%20cero%3A%20El%20origen%20de%20datos%20y%20la%20carga%20inicial%20de%20datos.&amp;url=http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html"
                        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    </a>
                    <a class="fi-social-google-plus" href="https://plus.google.com/share?url=http://www.lametaweb.com/2015/06/15/Desarrollo-de-una-aplicacion-desde-cero-El-origen-de-datos-y-la-carga-inicial-de-datos.html"
                       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    </a>
                </section>

                <section class="author">
                    <header>
                        <span>About the author</span>
                    </header>
                    <section>
                        <h4>La metaweb</h4>
                        <img src="https://avatars.githubusercontent.com/u/11819148?v=3">
                        
                        
                    </section>
                    <footer>
                         <p></p>
                    </footer>
                </section>

        <div class="clearfix"></div>
                    <hr>

            </footer>

        <h3 class="title-disqus"><span class="fi-comments"></span>Discussions</h3>




        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'lametaweb'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

</div>

</div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <!--[if lte IE 8]>
        <script type="text/javascript" src="//www.lametaweb.com/themes/ichi/assets/js/outdatedBrowser.min.js?v=1.0.0"></script>
    <![endif]-->
    <script type="text/javascript" src="//www.lametaweb.com/themes/ichi/assets/js/min/built.js?v=1.0.0"></script>

    <script>
      $(document).foundation();
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-62743682-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
